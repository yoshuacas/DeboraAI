// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id               String            @id @default(cuid())
  email            String            @unique
  password         String
  name             String
  role             Role              @default(CUSTOMER)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Extended fields for Debora (lawyers)
  firstName        String?
  lastName         String?
  phone            String?
  contactEmail     String?
  contactAddress   String?
  subscriptionPlan SubscriptionPlan  @default(FREE)
  subscriptionEnds DateTime?

  chats            Chat[]
  sessions         Session[]
  clients          Client[]
  library          LibraryDocument[]
  templates        Template[]
  calendarEvents   CalendarEvent[]
}

// NextAuth session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())

  @@index([userId])
}

enum Role {
  ADMIN
  CUSTOMER
}

enum SubscriptionPlan {
  FREE
  PROFESSIONAL
  ENTERPRISE
}

// Chat conversations (both coding agent and legal agent)
model Chat {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  String   // JSON stringified array of {role, content, timestamp}
  type      ChatType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum ChatType {
  CODING
  LEGAL
}

// Track code changes made by the coding agent
model CodeChange {
  id                    String   @id @default(cuid())
  commitHash            String   @unique
  description           String
  filesChanged          String   // JSON stringified array of file paths
  adminId               String
  testsPassed           Boolean
  deployedToStaging     Boolean  @default(false)
  deployedToProduction  Boolean  @default(false)
  createdAt             DateTime @default(now())

  @@index([adminId])
  @@index([deployedToStaging])
  @@index([deployedToProduction])
}

// Clients managed by lawyers
model Client {
  id             String    @id @default(cuid())
  email          String
  firstName      String
  lastName       String
  phone          String?
  contactEmail   String?
  contactAddress String?
  dateOfBirth    DateTime?
  idNumber       String?

  lawyerId       String
  lawyer         User      @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  cases          Case[]

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([lawyerId])
}

// Legal cases
model Case {
  id             String              @id @default(cuid())
  name           String
  court          String?
  status         CaseStatus          @default(OPEN)

  clientId       String
  client         Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)

  supportDocs    SupportDocument[]
  generatedDocs  GeneratedDocument[]
  calendarEvents CalendarEvent[]

  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([clientId])
  @@index([status])
}

enum CaseStatus {
  OPEN
  IN_PROGRESS
  CLOSED
  ARCHIVED
}

// Support documents for cases
model SupportDocument {
  id        String   @id @default(cuid())
  name      String
  fileUrl   String
  fileType  String
  summary   String?
  tags      String   // JSON array

  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
}

// Generated documents for cases
model GeneratedDocument {
  id        String   @id @default(cuid())
  name      String
  fileUrl   String
  fileType  String
  summary   String?
  tags      String   // JSON array

  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
}

// Legal library documents
model LibraryDocument {
  id        String   @id @default(cuid())
  name      String
  fileUrl   String
  fileType  String
  summary   String?
  tags      String   // JSON array

  lawyerId  String
  lawyer    User     @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lawyerId])
}

// Document templates
model Template {
  id           String       @id @default(cuid())
  name         String
  templateType TemplateType
  fileUrl      String
  fileType     String
  summary      String?
  tags         String       // JSON array

  lawyerId     String
  lawyer       User         @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([lawyerId])
  @@index([templateType])
}

enum TemplateType {
  SALE_CONTRACT
  PETITION
  LAWSUIT
  POWER_OF_ATTORNEY
  RENTAL_AGREEMENT
  NDA
  SETTLEMENT
  COMPLAINT
  MOTION
  AFFIDAVIT
}

// Calendar events for case deadlines and meetings
model CalendarEvent {
  id          String    @id @default(cuid())
  title       String
  description String?
  eventDate   DateTime
  eventType   EventType

  caseId      String?
  case        Case?     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  lawyerId    String
  lawyer      User      @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([lawyerId])
  @@index([eventDate])
  @@index([caseId])
}

enum EventType {
  HEARING
  DEADLINE
  MEETING
  FILING
  OTHER
}
